<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisme Sales - Disparador de Mensagens</title>
    
    <!-- Meta e √çcones baseados no seu arquivo de refer√™ncia -->
    <meta name="theme-color" content="#2fc36a">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.png">
    
    <!-- Depend√™ncias de Estilo e Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Estilos personalizados inspirados no seu CRM */
        body {
            background-color: #f8fafc; /* slate-50 */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        /* Estilo customizado para o checkbox interativo */
        .status-checkbox-label {
            transition: all 0.2s ease-in-out;
        }

        .status-checkbox:checked + .status-checkbox-label {
            border-color: #2fc36a; /* Cor principal */
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            font-weight: 600;
        }

        .status-checkbox:checked + .status-checkbox-label .fa-circle {
            color: #2fc36a; /* Cor principal */
        }
        
        .form-input {
             margin-top: 4px; display: block; width: 100%; border-radius: 0.5rem; border: 1px solid #d4d4d8; padding: 0.75rem 1rem; background-color: #fafafa;
        }
        .form-input:focus { 
            border-color: #16a34a; outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #a7f3d0;
        }

        @keyframes pulse-feedback { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.02); } 
        }
        .feedback-loading { animation: pulse-feedback 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-4xl">
        <!-- Cabe√ßalho -->
        <div class="text-center mb-8">
            <img src="https://crm.prismeapp.com.br/web/binary/company_logo" alt="Logo Prisme Sales" class="mx-auto h-16 w-auto mb-4" onerror="this.style.display='none'">
            <h1 class="text-3xl font-bold text-gray-800">Disparador de Mensagens</h1>
            <p class="text-gray-500 mt-1">Seleciona as colunas de clientes, crie a mensagem e envie para relacionar!</p>
        </div>

        <!-- NOVO: Contador Din√¢mico -->
        <div class="mb-6 bg-slate-100 p-4 rounded-xl text-center shadow-sm">
            <span class="text-lg font-bold text-gray-700">Total de Empresas Selecionadas:</span>
            <span id="selected-count" class="ml-2 text-2xl font-extrabold text-[#2fc36a]">0</span>
        </div>


        <!-- Container Principal -->
        <div class="bg-white p-8 rounded-xl shadow-md space-y-8">
            
            <!-- Se√ß√£o de Filtros -->
            <div class="section">
                <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-4">1. Filtre por Status</h3>
                <div id="status-filters" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                    <div>
                        <input type="checkbox" id="status1" name="status" value="üöÄ KickOFF" class="hidden status-checkbox">
                        <label for="status1" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> üöÄ KickOFF
                        </label>
                    </div>
                    <div>
                        <input type="checkbox" id="status2" name="status" value="üìåImplementa√ß√£o" class="hidden status-checkbox">
                        <label for="status2" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> üìå Implementa√ß√£o
                        </label>
                    </div>
                    <div>
                        <input type="checkbox" id="status3" name="status" value="‚è±Ô∏èPrimeiros 90 dias" class="hidden status-checkbox">
                        <label for="status3" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> ‚è±Ô∏è Primeiros 90 dias
                        </label>
                    </div>
                    <div>
                        <input type="checkbox" id="status4" name="status" value="üõ†Ô∏èManuten√ß√£o" class="hidden status-checkbox">
                        <label for="status4" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> üõ†Ô∏è Manuten√ß√£o
                        </label>
                    </div>
                    <div>
                        <input type="checkbox" id="status5" name="status" value="‚ùåCancelados" class="hidden status-checkbox">
                        <label for="status5" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> ‚ùå Cancelados
                        </label>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Filtros de Tags -->
            <div class="section">
                <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-4">2. Filtre por Tags <span class="text-sm font-normal text-gray-500">(Opcional)</span></h3>
                <div id="tag-filters" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                    <div>
                        <input type="checkbox" id="tag1" name="tag" value="TAG-01" class="hidden status-checkbox">
                        <label for="tag1" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> Chatbot
                        </label>
                    </div>
                    <div>
                        <input type="checkbox" id="tag2" name="tag" value="TAG-02" class="hidden status-checkbox">
                        <label for="tag2" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> Trafego Pago
                        </label>
                    </div>
                    <div>
                        <input type="checkbox" id="tag3" name="tag" value="TAG-03" class="hidden status-checkbox">
                        <label for="tag3" class="status-checkbox-label cursor-pointer flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-gray-400">
                           <i class="fas fa-circle text-gray-300 mr-3"></i> Terceiriza√ß√£o de Vendas
                        </label>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Mensagem -->
            <div class="section">
                <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-4">3. Escreva a Mensagem</h3>
                <div class="toolbar mb-2">
                    <button onclick="formatText('bold')" title="Negrito (Ctrl+B)" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-md"><i class="fas fa-bold"></i></button>
                    <button onclick="formatText('italic')" title="It√°lico (Ctrl+I)" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-md"><i class="fas fa-italic"></i></button>
                </div>
                <textarea id="message-composer" rows="6" class="form-input !mt-0" placeholder="Digite sua mensagem aqui..."></textarea>
            </div>
            
            <!-- Se√ß√£o de Agendamento -->
            <div class="section">
                <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-4">4. Agende o Disparo <span class="text-sm font-normal text-gray-500">(Opcional)</span></h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="schedule-date" class="text-sm font-medium text-gray-700">Data de In√≠cio</label>
                        <input type="date" id="schedule-date" class="form-input">
                    </div>
                    <div>
                        <label for="schedule-time" class="text-sm font-medium text-gray-700">Hora de In√≠cio</label>
                        <input type="time" id="schedule-time" class="form-input">
                    </div>
                </div>
            </div>

            <!-- Bot√£o de Envio e Feedback -->
            <div class="pt-4">
                 <button id="send-button" class="w-full px-4 py-3 text-lg font-semibold text-white bg-[#2fc36a] rounded-full hover:bg-[#29a85b] transition-colors flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                     <span id="send-button-icon" class="mr-3"><i class="fas fa-paper-plane"></i></span>
                     <span id="send-button-text">Preparar e Enviar</span>
                 </button>
                 <div id="feedback" class="hidden mt-4 p-3 text-sm text-center font-semibold rounded-lg"></div>
            </div>
        </div>

        <!-- Se√ß√£o de √öltimos Agendamentos -->
        <div class="w-full max-w-4xl mt-8">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <h3 class="text-lg font-bold text-gray-700 border-b pb-2 mb-4 flex items-center">
                    <i class="fas fa-history mr-3"></i>√öltimos Agendamentos
                </h3>
                <div id="schedule-list" class="space-y-3">
                    <div id="schedule-loader" class="text-center text-gray-500 py-4">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Carregando agendamentos...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Envio -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 transition-opacity duration-300" onclick="hideConfirmationModal()">
        <div id="confirmation-modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">Revisar e Confirmar</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-gray-600">Por favor, revise os detalhes abaixo antes de confirmar a a√ß√£o.</p>
                <div class="bg-slate-50 p-4 rounded-lg space-y-3 border">
                    <div>
                        <span class="font-semibold text-gray-700">Filtros de Status:</span>
                        <p id="review-statuses" class="text-gray-600"></p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Filtros de Tags:</span>
                        <p id="review-tags" class="text-gray-600"></p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Total de Grupos Encontrados:</span>
                        <p id="review-group-count" class="text-gray-600 font-bold text-lg"></p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Agendamento:</span>
                        <p id="review-schedule" class="text-gray-600"></p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Pr√©via da Mensagem:</span>
                        <div id="review-message" class="mt-1 p-3 border bg-white rounded-md max-h-40 overflow-y-auto text-sm text-gray-800 whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-end items-center gap-3 rounded-b-xl">
                <button id="cancel-send-btn" class="px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">Cancelar</button>
                <button id="confirm-send-btn" class="px-6 py-2 rounded-full text-white bg-[#2fc36a] hover:bg-[#29a85b] font-semibold flex items-center justify-center">
                    <!-- O texto ser√° din√¢mico -->
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o Gen√©rico (para o Cancelar) -->
    <div id="generic-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p id="generic-confirmation-message" class="text-lg text-gray-800 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="generic-confirm-cancel-btn" class="px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">Cancelar</button>
                <button id="generic-confirm-action-btn" class="px-6 py-2 rounded-full text-white bg-red-500 hover:bg-red-600 font-semibold">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // --- IN√çCIO: CONFIGURA√á√ÉO DO SUPABASE ---
        const SUPABASE_URL = 'https://ccenxfyqwtfpexltuwrn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZW54Znlxd3RmcGV4bHR1d3JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzE1MTMsImV4cCI6MjA2ODg0NzUxM30.6un31sODuCyd5Dz_pR_kn656k74jjh5CNAfF0YteT7I';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // --- FIM: CONFIGURA√á√ÉO DO SUPABASE ---

        const WEBHOOK_URL = 'https://prismen8n.prismeapp.com.br/webhook/prepara-envio';
        let payloadToSend = null; 

        // --- IN√çCIO: Elementos do DOM ---
        const sendButton = document.getElementById('send-button');
        const sendButtonText = document.getElementById('send-button-text');
        const sendButtonIcon = document.getElementById('send-button-icon');
        const feedbackDiv = document.getElementById('feedback');
        const messageComposer = document.getElementById('message-composer');
        const statusCheckboxes = document.querySelectorAll('input[name="status"]');
        const tagCheckboxes = document.querySelectorAll('input[name="tag"]');
        const scheduleDateInput = document.getElementById('schedule-date');
        const scheduleTimeInput = document.getElementById('schedule-time');
        const scheduleListDiv = document.getElementById('schedule-list');
        const selectedCountSpan = document.getElementById('selected-count');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationModalContent = document.getElementById('confirmation-modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelSendBtn = document.getElementById('cancel-send-btn');
        const confirmSendBtn = document.getElementById('confirm-send-btn');
        const genericConfirmationModal = document.getElementById('generic-confirmation-modal');
        const genericConfirmMsg = document.getElementById('generic-confirmation-message');
        const genericConfirmActionBtn = document.getElementById('generic-confirm-action-btn');
        const genericConfirmCancelBtn = document.getElementById('generic-confirm-cancel-btn');
        // --- FIM: Elementos do DOM ---
        
        // --- IN√çCIO: L√≥gica do Modal de Confirma√ß√£o Gen√©rico ---
        let onConfirmCallback = null;
        function showGenericConfirmationModal(message, onConfirm) {
            genericConfirmMsg.textContent = message;
            onConfirmCallback = onConfirm;
            genericConfirmationModal.classList.remove('hidden');
            genericConfirmationModal.classList.add('flex');
        }
        function hideGenericConfirmationModal() {
            genericConfirmationModal.classList.add('hidden');
            genericConfirmationModal.classList.remove('flex');
            onConfirmCallback = null;
        }
        genericConfirmCancelBtn.addEventListener('click', hideGenericConfirmationModal);
        genericConfirmActionBtn.addEventListener('click', () => {
            if (typeof onConfirmCallback === 'function') { onConfirmCallback(); }
            hideGenericConfirmationModal();
        });
        // --- FIM: L√≥gica do Modal de Confirma√ß√£o Gen√©rico ---
        
        function getStatusInfo(status) {
            switch (status) {
                case 'concluido': return { text: 'Conclu√≠do', color: 'green', icon: 'fa-check-circle' };
                case 'pendente': return { text: 'Pendente', color: 'yellow', icon: 'fa-clock' };
                case 'erro': return { text: 'Erro', color: 'red', icon: 'fa-exclamation-triangle' };
                case 'processando': return { text: 'Processando', color: 'blue', icon: 'fa-spinner fa-spin' };
                case 'cancelado': return { text: 'Cancelado', color: 'gray', icon: 'fa-ban' };
                default: return { text: status || 'Desconhecido', color: 'gray', icon: 'fa-question-circle' };
            }
        }
        
        function renderSchedules(schedules) {
            if (!schedules || schedules.length === 0) {
                scheduleListDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum agendamento encontrado.</p>`;
                return;
            }
            const html = schedules.map(schedule => {
                const statusInfo = getStatusInfo(schedule.status);
                const groupCount = Array.isArray(schedule.grupos_whatsapp) ? schedule.grupos_whatsapp.length : 0;
                const messageSnippet = schedule.mensagem.substring(0, 45) + (schedule.mensagem.length > 45 ? '...' : '');
                const scheduleDate = new Date(schedule.disparar_em);
                const formattedDate = scheduleDate.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const cancelButton = schedule.status === 'pendente' ? `<button title="Cancelar Agendamento" class="cancel-schedule-btn text-red-400 hover:text-red-600 ml-4" data-schedule-id="${schedule.id}"><i class="fas fa-trash-alt"></i></button>` : '';
                return `<div class="p-4 rounded-lg border-l-4 border-${statusInfo.color}-400 bg-${statusInfo.color}-50 flex items-center justify-between gap-4"> <div class="flex-grow min-w-0"> <p class="font-semibold text-gray-800 truncate" title="${schedule.mensagem}">"${messageSnippet}"</p> <p class="text-sm text-gray-500 mt-1"> <i class="fas fa-users mr-1"></i> ${groupCount} grupos | <i class="far fa-calendar-alt ml-3 mr-1"></i> ${formattedDate} </p> </div> <div class="flex-shrink-0 flex items-center"> <span class="font-bold text-sm text-${statusInfo.color}-700 bg-${statusInfo.color}-200 px-3 py-1 rounded-full flex items-center"> <i class="fas ${statusInfo.icon} mr-2"></i> <span>${statusInfo.text}</span> </span> ${cancelButton}</div> </div>`;
            }).join('');
            scheduleListDiv.innerHTML = html;
        }

        async function fetchLatestSchedules() {
            try {
                const { data, error } = await supabaseClient.from('agendamentos').select('id, mensagem, grupos_whatsapp, status, disparar_em').order('created_at', { ascending: false }).limit(5);
                if (error) throw new Error(`Erro ao buscar agendamentos: ${error.message}`);
                renderSchedules(data);
            } catch (err) {
                console.error(err);
                scheduleListDiv.innerHTML = `<p class="text-center text-red-500 py-4">${err.message}</p>`;
            }
        }
        
        async function handleCancelSchedule(scheduleId) {
            const confirmAction = async () => {
                const buttonElement = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
                if(buttonElement) {
                    buttonElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                    buttonElement.disabled = true;
                }
                try {
                    const { error } = await supabaseClient
                        .from('agendamentos')
                        .update({ status: 'cancelado' })
                        .eq('id', scheduleId)
                        .eq('status', 'pendente');
                    if (error) throw error;
                    // For√ßa a atualiza√ß√£o do front-end ap√≥s o sucesso da opera√ß√£o
                    await fetchLatestSchedules();
                } catch (error) {
                    console.error('Erro ao cancelar agendamento:', error);
                    showFeedback(`N√£o foi poss√≠vel cancelar: ${error.message}`, 'error');
                    // Restaura o bot√£o em caso de erro
                    if(buttonElement) {
                       buttonElement.innerHTML = `<i class="fas fa-trash-alt"></i>`;
                       buttonElement.disabled = false;
                    }
                }
            };
            showGenericConfirmationModal('Tem certeza que deseja cancelar este agendamento? Esta a√ß√£o n√£o pode ser desfeita.', confirmAction);
        }

        function setupRealtimeSchedules() {
            supabaseClient.channel('public:agendamentos').on('postgres_changes', { event: '*', schema: 'public', table: 'agendamentos' }, (payload) => { fetchLatestSchedules(); }).subscribe();
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        async function updateSelectedCount() {
            selectedCountSpan.innerHTML = `<i class="fas fa-spinner fa-spin text-lg"></i>`;
            const selectedStatuses = Array.from(statusCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            const selectedTags = Array.from(tagCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (selectedStatuses.length === 0) { selectedCountSpan.textContent = '0'; return; }
            try {
                const { data: clientsByStatus, error: statusError } = await supabaseClient.from('clientes').select('id_cliente').in('status', selectedStatuses);
                if (statusError) throw statusError;
                let finalClientIds = (clientsByStatus || []).map(c => c.id_cliente);
                if (selectedTags.length > 0 && finalClientIds.length > 0) {
                    const { data: clientsWithTags, error: tagError } = await supabaseClient.from('cliente_tags').select('id_cliente').in('id_cliente', finalClientIds).in('id_tag', selectedTags);
                    if (tagError) throw tagError;
                    const taggedClientIds = new Set((clientsWithTags || []).map(ct => ct.id_cliente));
                    finalClientIds = finalClientIds.filter(id => taggedClientIds.has(id));
                }
                selectedCountSpan.textContent = finalClientIds.length;
            } catch (error) {
                console.error("Erro ao contar clientes:", error);
                selectedCountSpan.textContent = '?';
            }
        }
        const debouncedUpdateCount = debounce(updateSelectedCount, 500);

        function showConfirmationModal() {
            confirmationModal.classList.remove('hidden'); confirmationModal.classList.add('flex');
            requestAnimationFrame(() => { confirmationModal.classList.remove('opacity-0'); confirmationModalContent.classList.remove('scale-95', 'opacity-0'); });
        }
        function hideConfirmationModal() {
            confirmationModal.classList.add('opacity-0'); confirmationModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { confirmationModal.classList.add('hidden'); confirmationModal.classList.remove('flex'); }, 300);
        }
        closeModalBtn.addEventListener('click', hideConfirmationModal);
        cancelSendBtn.addEventListener('click', hideConfirmationModal);

        function updateButtonUI() {
            if (scheduleDateInput.value && scheduleTimeInput.value) {
                sendButtonText.textContent = 'Agendar Envio'; sendButtonIcon.innerHTML = '<i class="fas fa-clock"></i>';
            } else {
                sendButtonText.textContent = 'Preparar e Enviar'; sendButtonIcon.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }
        scheduleDateInput.addEventListener('input', updateButtonUI);
        scheduleTimeInput.addEventListener('input', updateButtonUI);

        function formatText(style) {
            const start = messageComposer.selectionStart; const end = messageComposer.selectionEnd;
            const selectedText = messageComposer.value.substring(start, end);
            if (!selectedText) { messageComposer.focus(); return; }
            let formattedText;
            if (style === 'bold') { formattedText = `*${selectedText}*`; } 
            else if (style === 'italic') { formattedText = `_${selectedText}_`; } 
            else { return; }
            messageComposer.value = messageComposer.value.substring(0, start) + formattedText + messageComposer.value.substring(end);
            messageComposer.focus(); messageComposer.setSelectionRange(start, start + formattedText.length);
        }
        messageComposer.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                if (e.key === 'b' || e.key === 'B') { e.preventDefault(); formatText('bold'); } 
                else if (e.key === 'i' || e.key === 'I') { e.preventDefault(); formatText('italic'); }
            }
        });

        function showFeedback(message, type) {
            feedbackDiv.textContent = message;
            feedbackDiv.className = 'block mt-4 p-3 text-sm text-center font-semibold rounded-lg ';
            if (type === 'success') feedbackDiv.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') feedbackDiv.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'loading') feedbackDiv.classList.add('bg-blue-100', 'text-blue-800', 'feedback-loading');
        }

        async function openReviewAndConfirm() {
            sendButton.disabled = true; showFeedback('Validando e buscando dados...', 'loading');
            const selectedStatuses = Array.from(statusCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            const selectedTags = Array.from(tagCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (selectedStatuses.length === 0) { showFeedback('Erro: Por favor, selecione pelo menos um status para filtrar.', 'error'); sendButton.disabled = false; return; }
            const message = messageComposer.value.trim();
            if (!message) { showFeedback('Erro: O campo de mensagem n√£o pode estar vazio.', 'error'); sendButton.disabled = false; return; }
            let disparar_em = null; const dateValue = scheduleDateInput.value; const timeValue = scheduleTimeInput.value;
            let formattedSchedule = "Imediato";
            if (dateValue && timeValue) {
                const combinedDateTime = new Date(`${dateValue}T${timeValue}`);
                if (combinedDateTime < new Date()) { showFeedback('Erro: A data e hora do agendamento n√£o podem estar no passado.', 'error'); sendButton.disabled = false; return; }
                disparar_em = combinedDateTime.toISOString();
                formattedSchedule = combinedDateTime.toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'short' });
            } else if (dateValue || timeValue) { showFeedback('Erro: Para agendar, preencha tanto a data quanto a hora.', 'error'); sendButton.disabled = false; return; }
            try {
                let { data: clientsByStatus, error: statusError } = await supabaseClient.from('clientes').select('id_cliente, link_grupo_whatsapp').in('status', selectedStatuses);
                if (statusError) throw new Error(`Erro ao buscar clientes por status: ${statusError.message}`);
                let finalClients = clientsByStatus || [];
                if (selectedTags.length > 0 && finalClients.length > 0) {
                    const clientIdsByStatus = finalClients.map(c => c.id_cliente);
                    const { data: clientsWithTags, error: tagError } = await supabaseClient.from('cliente_tags').select('id_cliente').in('id_cliente', clientIdsByStatus).in('id_tag', selectedTags);
                    if (tagError) throw new Error(`Erro ao buscar tags de clientes: ${tagError.message}`);
                    const clientIdsWithTags = [...new Set((clientsWithTags || []).map(ct => ct.id_cliente))];
                    finalClients = finalClients.filter(client => clientIdsWithTags.includes(client.id_cliente));
                }
                const groupLinks = finalClients.map(c => c.link_grupo_whatsapp).filter(link => link && link.trim() !== '');
                if (groupLinks.length === 0) { showFeedback('Nenhum cliente com link de grupo v√°lido foi encontrado com os filtros selecionados.', 'error'); sendButton.disabled = false; return; }
                payloadToSend = { message: message, whatsapp_groups: groupLinks, disparar_em: disparar_em };
                const tagMap = { 'TAG-01': 'Chatbot', 'TAG-02': 'Trafego Pago', 'TAG-03': 'Terceiriza√ß√£o de Vendas' };
                const selectedTagNames = selectedTags.map(tag => tagMap[tag] || tag);
                document.getElementById('review-statuses').textContent = selectedStatuses.join(', ');
                document.getElementById('review-tags').textContent = selectedTagNames.length > 0 ? selectedTagNames.join(', ') : "Nenhuma";
                document.getElementById('review-group-count').textContent = `${groupLinks.length} grupos`;
                document.getElementById('review-schedule').textContent = formattedSchedule;
                document.getElementById('review-message').textContent = message;
                confirmSendBtn.innerHTML = disparar_em ? '<i class="fas fa-clock mr-2"></i>Confirmar Agendamento' : '<i class="fas fa-paper-plane mr-2"></i>Confirmar Envio';
                feedbackDiv.classList.add('hidden');
                showConfirmationModal();
            } catch (err) {
                console.error('Ocorreu um erro:', err);
                showFeedback(`Falha na opera√ß√£o: ${err.message}`, 'error');
            } finally {
                sendButton.disabled = false;
            }
        }

        async function confirmAndSendData() {
            hideConfirmationModal();
            if (!payloadToSend) { showFeedback('Erro: Dados para envio n√£o encontrados.', 'error'); return; }
            const actionText = payloadToSend.disparar_em ? 'Agendando envio' : 'Enviando dados';
            showFeedback(`${actionText} para ${payloadToSend.whatsapp_groups.length} grupos...`, 'loading');
            try {
                const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadToSend) });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na comunica√ß√£o com o servidor. Status: ${response.status}. Resposta: ${errorText}`);
                }
                showFeedback(`Sucesso! O processo foi iniciado. A Eve vai notificar sobre o in√≠cio e a finaliza√ß√£o no grupo do Relacionamento.`, 'success');
                messageComposer.value = ''; scheduleDateInput.value = ''; scheduleTimeInput.value = '';
                updateButtonUI();
            } catch (err) {
                console.error('Ocorreu um erro na confirma√ß√£o:', err);
                showFeedback(`Falha na opera√ß√£o: ${err.message}`, 'error');
            } finally {
                payloadToSend = null;
            }
        }

        // --- IN√çCIO: Execu√ß√£o Principal ---
        sendButton.addEventListener('click', openReviewAndConfirm);
        confirmSendBtn.addEventListener('click', confirmAndSendData);
        scheduleListDiv.addEventListener('click', function(event) {
            const cancelButton = event.target.closest('.cancel-schedule-btn');
            if (cancelButton) {
                const scheduleId = cancelButton.dataset.scheduleId;
                handleCancelSchedule(scheduleId);
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            fetchLatestSchedules();
            setupRealtimeSchedules();
            statusCheckboxes.forEach(cb => cb.addEventListener('change', debouncedUpdateCount));
            tagCheckboxes.forEach(cb => cb.addEventListener('change', debouncedUpdateCount));
        });
        // --- FIM: Execu√ß√£o Principal ---
    </script>
</body>
</html>

